name: Build Robust Static Bash

on:
  workflow_dispatch:

jobs:
  build:
    name: Compile Static Bash (Source Deps)
    runs-on: ubuntu-latest
    container: alpine:latest
    
    steps:
      - name: Install Build Tools
        run: |
          apk update
          apk add --no-cache build-base curl linux-headers

      - name: Build Static Ncurses
        run: |
          # 1. Download Ncurses
          NCURSES_VER="6.4"
          curl -LO "https://ftp.gnu.org/gnu/ncurses/ncurses-$NCURSES_VER.tar.gz"
          tar -xzf "ncurses-$NCURSES_VER.tar.gz"
          cd ncurses-$NCURSES_VER
          
          # 2. Configure Ncurses for static usage
          # --without-shared: Only build .a files
          # --with-termlib: Includes terminal capability database support (crucial for Bash)
          # --enable-pc-files: Helps build process find the libraries
          ./configure \
            --prefix=/usr/local \
            --without-shared \
            --with-normal \
            --without-debug \
            --without-cxx \
            --enable-static \
            --with-termlib \
            --enable-pc-files
          
          make -j$(nproc)
          make install

      - name: Build Static Bash
        run: |
          # 1. Download Bash
          BASH_VER="5.2.21"
          curl -LO "https://ftp.gnu.org/gnu/bash/bash-$BASH_VER.tar.gz"
          tar -xzf "bash-$BASH_VER.tar.gz"
          cd bash-$BASH_VER
          
          # 2. Configure Bash
          # --disable-nls: Disables native language support (avoids complex libintl/iconv link errors)
          # LDFLAGS="-static": Forces static linking for the final binary
          export CFLAGS="-Os -static"
          export LDFLAGS="-static -L/usr/local/lib"
          export CPPFLAGS="-I/usr/local/include"
          
          ./configure \
            --enable-static-link \
            --without-bash-malloc \
            --disable-nls \
            --with-curses \
            --enable-readline
          
          # 3. Compile
          make -j$(nproc)
          
          # 4. Strip symbols
          strip bash

      - name: Verify Binary
        run: |
          cd bash-5.2.21
          echo "--- File Type ---"
          file bash
          
          echo "--- Linker Check (Should be empty or error) ---"
          ldd bash || echo "Success: Not a dynamic executable"
          
          echo "--- Run Check ---"
          ./bash --version

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bash-static-robust
          path: bash-5.2.21/bash
