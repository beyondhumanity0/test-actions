name: Build Static Bash 5.3

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Static Bash 5.3
    runs-on: ubuntu-latest
    container: alpine:latest
    
    steps:
      - name: Install Build Tools
        run: |
          apk update
          apk add --no-cache build-base curl linux-headers bison

      - name: Build Static Ncurses
        run: |
          NCURSES_VER="6.5"
          curl -LO "https://ftp.gnu.org/gnu/ncurses/ncurses-$NCURSES_VER.tar.gz"
          tar -xzf "ncurses-$NCURSES_VER.tar.gz"
          cd ncurses-$NCURSES_VER
          
          # Use -fPIC and -std=gnu89 for ncurses to handle older macro definitions
          export CFLAGS="-Os -fPIC -std=gnu89"
          
          ./configure \
            --prefix=/usr/local \
            --without-shared \
            --with-normal \
            --without-debug \
            --without-cxx \
            --enable-static \
            --with-termlib \
            --enable-pc-files
          
          make -j$(nproc)
          make install

      - name: Build Static Bash 5.3
        run: |
          # Downloading Bash 5.3 (Alpha/RC/Release)
          # Note: If 5.3 is not in the 'gnu' folder yet, it is in 'bash-testing'
          curl -LO "https://ftp.gnu.org/gnu/bash/bash-5.3-alpha.tar.gz" || \
          curl -LO "https://ftp.gnu.org/gnu/bash/bash-5.3.tar.gz"
          
          tar -xzf bash-5.3*.tar.gz
          cd bash-5.3*
          
          # CFLAGS for GCC 14 compatibility
          # We force gnu11 which is a good middle ground for Bash 5.3
          export CFLAGS="-Os -static -std=gnu11 -Wno-implicit-int -Wno-implicit-function-declaration"
          export CFLAGS_FOR_BUILD="-std=gnu11 -Wno-implicit-int -Wno-implicit-function-declaration"
          export LDFLAGS="-static -L/usr/local/lib"
          export CPPFLAGS="-I/usr/local/include"
          
          ./configure \
            --enable-static-link \
            --without-bash-malloc \
            --disable-nls \
            --with-curses \
            --enable-readline
          
          make -j$(nproc)
          strip bash

      - name: Verify Binary
        run: |
          # Use find to handle the folder name if it has -alpha suffix
          cd bash-5.3*
          echo "--- Binary Info ---"
          file bash
          ldd bash || echo "Static Check Passed"
          ./bash --version

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bash-5.3-static
          path: bash-5.3*/bash
