name: Build Static Bash

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build Static Bash on Alpine
    runs-on: ubuntu-latest
    container: alpine:latest
    
    steps:
      - name: Install Build Dependencies
        run: |
          apk update
          apk add --no-cache \
            build-base \
            curl \
            linux-headers \
            bison \
            ncurses-static \
            ncurses-dev

      - name: Download Sources
        run: |
          # Define versions
          BASH_VERSION="5.2.21"
          
          echo "Downloading Bash $BASH_VERSION..."
          curl -LO "https://ftp.gnu.org/gnu/bash/bash-$BASH_VERSION.tar.gz"
          tar -xzf "bash-$BASH_VERSION.tar.gz"

      - name: Build Bash
        run: |
          cd bash-5.2.21
          
          # Configure for static linking
          # --enable-static-link: Forces static linking
          # --without-bash-malloc: Uses system malloc (musl's) which is generally preferred for static builds
          export CFLAGS="-Os -static"
          export LDFLAGS="-static"
          
          ./configure \
            --enable-static-link \
            --without-bash-malloc \
            --with-curses \
            --enable-readline
            
          # Compile
          make -j$(nproc)
          
          # Strip symbols to reduce size
          strip bash

      - name: Verify Static Build
        run: |
          cd bash-5.2.21
          echo "--- Binary File Info ---"
          file bash
          
          echo "--- LDD Output (Should say 'Not a dynamic executable') ---"
          ldd bash || echo "Success: ldd failed as expected for static binary"
          
          echo "--- Version Check ---"
          ./bash --version

      - name: Prepare Artifact
        run: |
          mkdir output
          cp bash-5.2.21/bash output/bash-static
          chmod +x output/bash-static

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bash-static-binary
          path: output/bash-static
          if-no-files-found: error
