name: Build Static Bash 5.3 (Pkg-Config)

on:
  workflow_dispatch:

jobs:
  build:
    name: Build Static Bash 5.3
    runs-on: ubuntu-latest
    container: alpine:latest
    
    steps:
      - name: Install Build Tools
        run: |
          apk update
          apk add --no-cache build-base curl linux-headers bison pkgconfig

      - name: Build Static Ncurses
        run: |
          NCURSES_VER="6.5"
          curl -LO "https://ftp.gnu.org/gnu/ncurses/ncurses-$NCURSES_VER.tar.gz"
          tar -xzf "ncurses-$NCURSES_VER.tar.gz"
          cd ncurses-$NCURSES_VER
          
          export CFLAGS="-Os -fPIC -std=gnu89"
          
          # --enable-pc-files: Generates the .pc files pkg-config needs
          # --with-pkg-config-libdir: Defines where those .pc files go
          ./configure \
            --prefix=/usr/local \
            --without-shared \
            --with-normal \
            --without-debug \
            --without-cxx \
            --enable-static \
            --with-termlib \
            --disable-widec \
            --enable-pc-files \
            --with-pkg-config-libdir=/usr/local/lib/pkgconfig
          
          make -j$(nproc)
          make install

      - name: Build Static Bash 5.3
        run: |
          curl -LO "https://ftp.gnu.org/gnu/bash/bash-5.3-alpha.tar.gz" || \
          curl -LO "https://ftp.gnu.org/gnu/bash/bash-5.3.tar.gz"
          
          tar -xzf bash-5.3*.tar.gz
          cd bash-5.3*
          
          # Environment variables for pkg-config and compiler
          export PKG_CONFIG_PATH="/usr/local/lib/pkgconfig"
          export CFLAGS="-Os -static -std=gnu11 -Wno-implicit-int -Wno-implicit-function-declaration"
          export CFLAGS_FOR_BUILD="-std=gnu11 -Wno-implicit-int -Wno-implicit-function-declaration"
          
          # Query pkg-config for ncurses flags
          # This automatically handles -lncurses, -ltinfo, and the correct search paths
          NCURSES_LIBS=$(pkg-config --libs --static ncurses)
          NCURSES_CFLAGS=$(pkg-config --cflags ncurses)
          
          export LDFLAGS="-static -L/usr/local/lib"
          export LIBS="$NCURSES_LIBS"
          export CPPFLAGS="-I/usr/local/include $NCURSES_CFLAGS"
          
          ./configure \
            --enable-static-link \
            --without-bash-malloc \
            --disable-nls \
            --with-curses \
            --enable-readline
          
          # Use the libs discovered by pkg-config during the final link
          make -j$(nproc) LIBS="$NCURSES_LIBS"
          
          strip bash

      - name: Verify Binary
        run: |
          cd bash-5.3*
          echo "--- Binary Info ---"
          file bash
          ldd bash || echo "Static check passed"
          ./bash --version

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bash-5.3-static-pkgconfig
          path: bash-5.3*/bash
